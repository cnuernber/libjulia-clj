<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Julia, The JVM, and Signals</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version">1.000-beta-8</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="gc.html"><div class="inner"><span>JVM/Julia Garbage Collection Integration</span></div></a></li><li class="depth-1  current"><a href="signals.html"><div class="inner"><span>Julia, The JVM, and Signals</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>libjulia-clj</span></div></div></li><li class="depth-2 branch"><a href="libjulia-clj.java-api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>java-api</span></div></a></li><li class="depth-2"><a href="libjulia-clj.julia.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>julia</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1>Julia, The JVM, and Signals</h1>
<p>Julia and the JVM both rely on an operating concept called <a href="https://en.wikipedia.org/wiki/Signal_(IPC)">signals</a>
which are a simple method of IPC.  If you aren't familiar with them
it probably isn't necessary to get familiar right now but it is necessary
in order to use libjulia-clj for you to understand how the signal mechanism
in these two systems interact and what happens when they interact poorly.</p>
<h2>Two Worlds Collide</h2>
<p>When using both Julia and the JVM in the same process you are likely to run into
instances where, during their normal course of operation their respective usage of
signals conflict.  For instance, the JVM uses <code>SIGSEGV</code> during it's normal course of
operation and if the Julia handler for <code>SIGSEGV</code> is installed then things like a
normal JVM garbage collection run can cause the process to unceremoniously exit:</p>
<pre><code class="language-clojure">user&gt; (require '[libjulia-clj.julia :as julia])
nil
user&gt; (julia/initialize! {:signals-enabled? true})
16:14:40.838 [nRepl-session-926e4a65-853b-40b4-a182-0f4b8a0cdfa3] INFO libjulia-clj.impl.base - Attempting to initialize Julia at /home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so
16:14:40.875 [nRepl-session-926e4a65-853b-40b4-a182-0f4b8a0cdfa3] INFO tech.v3.jna.base - Library /home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so found at [:system "/home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so"]
16:14:40.881 [nRepl-session-926e4a65-853b-40b4-a182-0f4b8a0cdfa3] INFO libjulia-clj.impl.jna - Julia startup options: n-threads null, signals? true
:ok
user&gt; (System/gc)

*** Closed on Mon Dec 14 16:14:45 2020 ***
</code></pre>
<p>Julia has an option to disable its use of signals but this results in a crash as it
requires the use of at least <code>SIGINT</code> in order to manage garbage collection in
multithreaded code.</p>
<p>If we simply disable Julia's use of signals then single-threaded code works fine.
Multithreaded code, however, will eventually crash without warning:</p>
<pre><code class="language-clojure">user&gt; (require '[libjulia-clj.julia :as julia])
nil
user&gt; (julia/initialize! {:n-threads 8 :signals-enabled? false})
16:28:10.854 [nRepl-session-a6713b61-bf94-4492-bcbb-7cc7e44c2a4f] INFO libjulia-clj.impl.base - Attempting to initialize Julia at /home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so
16:28:10.908 [nRepl-session-a6713b61-bf94-4492-bcbb-7cc7e44c2a4f] INFO tech.v3.jna.base - Library /home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so found at [:system "/home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so"]
16:28:10.925 [nRepl-session-a6713b61-bf94-4492-bcbb-7cc7e44c2a4f] INFO libjulia-clj.impl.jna - Julia startup options: n-threads 8, signals? false
:ok
user&gt; (System/gc)
nil
user&gt; (julia/eval-string "Threads.@threads for i in 1:1000; zeros(1024, 1024) .+ zeros(1024, 1024); end")

*** Closed on Mon Dec 14 16:28:25 2020 ***
</code></pre>
<h2>The Work-Around For Now</h2>
<p>The JVM has a facility for <a href="https://docs.oracle.com/javase/10/troubleshoot/handle-signals-and-exceptions.htm#JSTGD356">signal chaining</a>.  This allows us to launch the JVM
in a particular way where installs a handler that listens for entities attempting
to install a signal handler and it records these handlers.  When a signal occurse,
it can detect whether it came from the JVM or from an outside entity and thus route
the correct signal to the correct handler as required.</p>
<p>Using this facility is fairly simple, setup an environment variable  LD_PRELOAD that
forces the operating system to load a shared library that exports functions that
allow the JVM to chain signals as opposed to simply handling them.</p>
<p>If we modify our example from before with this pathway we can successfully run
our example:</p>
<pre><code class="language-console">chrisn@chrisn-lt-01:~/dev/cnuernber/libjulia-clj$ find /usr -name "*jsig*"
/usr/lib/jvm/java-11-openjdk-amd64/lib/server/libjsig.so
/usr/lib/jvm/java-11-openjdk-amd64/lib/libjsig.so
/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server/libjsig.so
/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/libjsig.so
chrisn@chrisn-lt-01:~/dev/cnuernber/libjulia-clj$ export LD_PRELOAD=/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/libjsig.so
</code></pre>
<pre><code class="language-clojure">user&gt; (require '[libjulia-clj.julia :as julia])
nil
user&gt; ;;Signals are automatically enabled if n-threads has a value
user&gt; (julia/initialize! {:n-threads 8})
16:37:40.695 [nRepl-session-447a06c6-bf23-4338-9618-34e0f841c82b] INFO libjulia-clj.impl.base - Attempting to initialize Julia at /home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so
16:37:40.741 [nRepl-session-447a06c6-bf23-4338-9618-34e0f841c82b] INFO tech.v3.jna.base - Library /home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so found at [:system "/home/chrisn/dev/cnuernber/libjulia-clj/julia-1.5.3/lib/libjulia.so"]
16:37:40.747 [nRepl-session-447a06c6-bf23-4338-9618-34e0f841c82b] INFO libjulia-clj.impl.jna - Julia startup options: n-threads 8, signals? true
:ok
user&gt; (julia/eval-string "Threads.@threads for i in 1:1000; zeros(1024, 1024) .+ zeros(1024, 1024); end")
nil
</code></pre>
<p>So, for now, we have to setup some nonstandard JVM state in order to use Julia to
it's full potential.  Still, it is pretty amazing that the chaining facility exists
and that it works as advertised and at least we have a solid pathway forward in
order to using Julia from the JVM or vice versa.</p>
</div></div></div></body></html>
